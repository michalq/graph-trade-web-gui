<!DOCTYPE html>
<html>
<head>
    <title>Graph Trade Web GUI</title>
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">

    <link rel="stylesheet" href="../components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">

    <!-- <script src="../components/fetch/fetch.js" type="text/javascript" charset="utf-8" async defer></script> -->
</head>
<body>

<div hidden class="alert alert-danger" id="error-block" role="alert">
  <strong>Oh snap!</strong> Change a few things up and try submitting again.
</div>

<div class="container">
    <div class="row">
        <h2>Most valuable paths list</h2>
    </div>
    <div class="row">
    <form>
        <div class="form-group">
            <label for="currency">Currency to sell</label>
            <input class="form-control" placeholder="ltc" id="currency" type="text" value="ltc" name="currency">
        </div>
        <div class="form-group">
            <label for="sell-currency">Amount</label>
            <input class="form-control" placeholder="1" id="amount" type="text" value="1" name="amount">
        </div>
        <div>
            <button class="btn btn-primary" id="search-paths" type="button">Search</button>
        </div>
        </form>
    </div>
    <div class="row">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Final balance</th>
                    <th>Revenue (%)</th>
                    <th>Currencies</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="paths-container"></tbody>
        </table>
    </div>
</div>

<template id="path-pattern">
    <tr>
        <td>
            {balances}
        </td>
        <td>{percentRevenue}%</td>
        <td>{currencies}</td>
        <td>
            <button
              class="btn btn-secondary"
              data-action-open-modal="#tpl-details-modal"
              data-path-index="{pathIndex}"
              >More</button>
        </td>
    </tr>
</template>

<template id="tpl-details-modal">
  <div class="modal" id="details-modal">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Path details</h5>
          <button type="button" class="close" data-action-close-modal="#details-modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="container-fluid">
            <div class="row">
              <div class="col-md-8">
                <h4>Steps</h4>
                <ol id="trade-steps"></ol>
              </div>
              <div class="col-md-4">
                <h4>Details</h4>
                <dl>
                  <dt>Revenue</dt>
                  <dd>10%</dd>
                </dl>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary float-left">Auto trade</button>
          <button type="button" class="btn btn-secondary">Refresh</button>
          <button type="button" class="btn btn-secondary" data-action-close-modal="#details-modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
    var jsonData = {};
    var searchPathButton = document.getElementById('search-paths');
    searchPathButton.addEventListener("click", function(e) {
        var currency = document.getElementById('currency').value;
        var amount = parseFloat(document.getElementById('amount').value);

        fetchPaths(
            currency,
            amount,
            renderPaths
        );
    });

    var fetchPaths = function(currency, amount, callback) {
        fetch('http://localhost:3000/api/v1/paths/initial/' + currency + '/amount/' + amount)
            .then(function(response) {
                return response.json();
            })
            .then(function(json) {
                if (typeof json.error == 'undefined') {
                    jsonData = json;
                    callback(json, currency, amount);
                } else {
                    showError(json.error.message);
                }
            }).catch(function(ex) {
                showError(ex.message);
            });
      };

    var renderPaths = function(response, originCurrency, originAmount) {
        var paths = response.paths,
            pathsContainer = document.getElementById('paths-container'),
            pathDom,
            innerHtml,
            balances,
            currencies,
            percentRevenue,
            currPath,
            highestRevenueId = null,
            highestRevenue = 0,
            rowId;

        for(var i = 0; i < paths.length; i++) {
            pathDom = document.querySelector('#path-pattern').cloneNode(true);
            innerHtml = pathDom.innerHTML;
            rowId = 'paths-row-' + i;

            currPath = paths[i];
            currencies = currPath.currencies.join(', ');
            percentRevenue = Math.floor((currPath.balance[originCurrency] - originAmount / originAmount) * 10000) / 100;
            balances = currPath.balance[originCurrency] + originCurrency.toUpperCase();

            if (percentRevenue > highestRevenue) {
                highestRevenueId = rowId;
                highestRevenue = percentRevenue;
            }

            innerHtml = innerHtml
                .replace('{pathIndex}', i)
                .replace('{balances}', balances)
                .replace('{currencies}', currencies)
                .replace('{percentRevenue}', percentRevenue);

            pathDom.innerHTML = innerHtml;
            pathDom.content.querySelector('tr').setAttribute('id', rowId)
            pathsContainer.appendChild(pathDom.content);
        }

        if (highestRevenueId) {
            document.getElementById(highestRevenueId).classList.add('table-success');
        }

        Modals.reload();
    };

    var showError = function(message) {
        var errorBlock = document.getElementById('error-block');
        var pathsContainer = document.getElementById('paths-container');
        errorBlock.removeAttribute('hidden');
        errorBlock.innerHTML = message;
        pathsContainer.innerHTML = '';
    };

    var hideError = function() {
        var errorBlock = document.getElementById('error-block');
        errorBlock.setAttribute('hidden');
        errorBlock.innerHTML = '';
    }

    var Modals = function() {
      //
    };

    Modals.reloadCloseTriggers = function() {
      var closeModalTriggers = document.querySelectorAll('[data-action-close-modal]');
      var closeModalTrigger;
      for (var i = 0; i < closeModalTriggers.length; i++) {
        closeModalTrigger = closeModalTriggers[i];
        closeModalTrigger.addEventListener('click', function(e) {
          var targetName = e.target.getAttribute('data-action-close-modal');
          document.querySelector(targetName).remove();
        });
      }
    };

    Modals.reload = function() {
      Modals.reloadCloseTriggers();
      var openModalTriggers = document.querySelectorAll('[data-action-open-modal]');
      var openModalTrigger;
      for (var i = 0; i < openModalTriggers.length; i++) {
        openModalTrigger = openModalTriggers[i];
        openModalTrigger.addEventListener('click', function(e) {
          var targetName = e.target.getAttribute('data-action-open-modal');
          var pathIndex = e.target.getAttribute('data-path-index');
          var selector = document.querySelector(targetName).cloneNode(true);
          var tradeStepsSelector = selector.content.querySelector('#trade-steps');
          // var innerHtml = selector.innerHTML;

          var tradeSteps = jsonData.paths[pathIndex].logs;
          for(var i = 0; i < tradeSteps.length; i++) {
            tradeStepsSelector.innerHTML += '<li>' + tradeSteps[i] + '</li>';
          }

          document
            .querySelector('body')
            .appendChild(selector.content);
          Modals.reloadCloseTriggers();
        });
      }
    };
    </script>
</body>
</html>