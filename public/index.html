<!DOCTYPE html>
<html>
<head>
  <title>Graph Trade Web GUI</title>
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">

  <link rel="stylesheet" href="../components/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/main.css">

  <!-- <script src="../components/fetch/fetch.js" type="text/javascript" charset="utf-8" async defer></script> -->
</head>
<body>

<div hidden class="alert alert-danger" id="error-block" role="alert"></div>

<div class="container-fluid">
  <nav class="col-sm-3 col-md-2 hidden-xs-down bg-faded sidebar">
    <ul class="nav nav-pills flex-column">
      <li class="nav-item">
        <a href="#all-paths" class="nav-link active">All paths</a>
      </li>
      <li class="nav-item">
        <a href="#my-paths" class="nav-link">My paths</a>
      </li>
      <li class="nav-item">
        <a href="#graphs" class="nav-link">Graphs</a>
      </li>
      <li class="nav-item">
        <a href="#graphs" class="nav-link">Settings</a>
      </li>
    </ul>
  </nav>
  <!-- Start - Optional block -->
  <div class="col-md-3 offset-sm-3 offset-md-2 sidebar-secondary">
    <form>
      <div class="form-group">
        <label for="currency">Currency to sell</label>
        <input class="form-control" placeholder="ltc" id="currency" type="text" value="ltc" name="currency">
      </div>
      <div class="form-group">
        <label for="sell-currency">Amount</label>
        <input class="form-control" placeholder="1" id="amount" type="text" value="1" name="amount">
      </div>
      <div>
        <button class="btn btn-primary" id="search-paths" type="button">Search</button>
      </div>
    </form>
  </div>
  <!-- End - Optional block -->

  <!-- Without optional block: offset-md-2 offset-sm-3 -->
  <main class="col-sm-6 col-md-7 pt-3 offset-md-5 offset-sm-6">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Final balance</th>
          <th>Revenue (%)</th>
          <th>Currencies</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="paths-container"></tbody>
    </table>
  </div>
  </main>
</div>

<template id="path-pattern">
  <tr>
    <td>
      {balances}
    </td>
    <td>{percentRevenue}%</td>
    <td>{currencies}</td>
    <td>
      <button
        class="btn btn-secondary btn-sm"
        data-action-open-modal="#tpl-details-modal"
        data-path-index="{pathIndex}"
        >More</button>
    </td>
  </tr>
</template>

<template id="tpl-details-modal">
  <div class="modal" id="details-modal">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Path details</h5>
          <button type="button" class="close" data-action-close-modal="#details-modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="container-fluid">
            <div class="row">
              <div class="col-md-12">
                <h4>Steps</h4>
                <table class="table table-hover table-bordered table-sm" data-trade-steps-table>
                  <thead class="thead-default">
                    <tr>
                      <th>#</th>
                      <th class="text-right">buying</th>
                      <th class="text-left">&curren;</th>
                      <th class="text-right">for</th>
                      <th class="text-left">&curren;</th>
                      <th class="text-right">unit price</th>
                      <th class="text-left">&curren;</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <ol data-trade-steps></ol>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <h4>Details</h4>
                <table class="table table-bordered" data-trade-steps-table>
                  <thead class="thead-default">
                    <tr>
                      <td>Revenue</td>
                      <td>Currencies</td>
                      <td>Final balance</td>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><span data-percent-revenue></span>%</td>
                      <td data-currencies>…</td>
                      <td data-final-balance>…</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <!-- <button type="button" class="btn btn-primary float-left">Auto trade</button> -->
          <!-- <button type="button" class="btn btn-secondary">Refresh</button> -->
          <button type="button" class="btn btn-secondary" data-action-close-modal="#details-modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
/**
 *
 */
class PathsService {
  constructor() {
    this.paths = {};
    this.triggerSearcherSelector = document.querySelector('#search-paths');
    this.currencySelector = document.querySelector('#currency');
    this.amountSelector = document.querySelector('#amount');

    this.initEvents();
  }

  getCurrency() {
    return this.currencySelector.value;
  }

  getAmount() {
    return parseFloat(this.amountSelector.value);
  }

  initEvents() {
    this.triggerSearcherSelector.addEventListener("click", e => {
      this.fetchPaths(
        this.getCurrency(),
        this.getAmount(),
        (response, currency, amount) => {
          const renderer = new PathsRenderer(response, currency, amount);
          renderer.renderPaths();
        }
      );
    });
  }

  fetchPaths(currency, amount, callback) {
    fetch('http://localhost:3000/api/v1/paths/initial/' + currency + '/amount/' + amount)
      .then(function(response) {
        return response.json();
      })
      .then(function(json) {
        if (typeof json.error == 'undefined') {
          jsonData = json;
          callback(json, currency, amount);
        } else {
          showError(json.error.message);
        }
      }).catch(function(ex) {
        showError(ex.message);
      });
  }
}

/**
 *
 */
class PathsRenderer {
  constructor(response, originCurrency, originAmount) {
    this.pathsContainer = document.querySelector('#paths-container');
    this.pathsContainer.innerHTML = '';
    this.response = response;
    this.currency = originCurrency;
    this.amount = originAmount;
  }

  renderPaths() {
    let paths = this.response.paths,
      pathDom,
      innerHtml,
      balances,
      currencies,
      percentRevenue,
      currPath,
      highestRevenueId = null,
      highestRevenue = 0,
      rowId;


    for(var i = 0; i < paths.length; i++) {
      pathDom = document.querySelector('#path-pattern').cloneNode(true);
      innerHtml = pathDom.innerHTML;
      rowId = 'paths-row-' + i;

      currPath = paths[i];
      currencies = currPath.currencies.join(', ');
      percentRevenue = currPath.percentRevenue;
      balances = currPath.balance[this.currency] + this.currency.toUpperCase();

      if (percentRevenue > highestRevenue) {
        highestRevenueId = rowId;
        highestRevenue = percentRevenue;
      }

      innerHtml = innerHtml
        .replace('{pathIndex}', i)
        .replace('{balances}', balances)
        .replace('{currencies}', currencies)
        .replace('{percentRevenue}', percentRevenue);

      pathDom.innerHTML = innerHtml;
      pathDom.content.querySelector('tr').setAttribute('id', rowId)
      this.pathsContainer.appendChild(pathDom.content);
    }

    if (highestRevenueId) {
      document.getElementById(highestRevenueId).classList.add('table-success');
    }

      Modals.reload();
    };
}

let paths = new PathsService;

var jsonData = {};

var showError = function(message) {
  var errorBlock = document.getElementById('error-block');
  var pathsContainer = document.getElementById('paths-container');
  errorBlock.removeAttribute('hidden');
  errorBlock.innerHTML = message;
  pathsContainer.innerHTML = '';
};

var hideError = function() {
  var errorBlock = document.getElementById('error-block');
  errorBlock.setAttribute('hidden');
  errorBlock.innerHTML = '';
}

/**
 *
 */
class Modals {
  /**
   *
   */
  static reloadCloseTriggers() {
    var closeModalTriggers = document.querySelectorAll('[data-action-close-modal]');
    var closeModalTrigger;
    for (var i = 0; i < closeModalTriggers.length; i++) {
      closeModalTrigger = closeModalTriggers[i];
      closeModalTrigger.addEventListener('click', function(e) {
        var targetName = e.target.getAttribute('data-action-close-modal');
        document.querySelector(targetName).remove();
      });
    }
  }

  /**
   *
   */
  static reload() {
    Modals.reloadCloseTriggers();
    var openModalTriggers = document.querySelectorAll('[data-action-open-modal]');
    var openModalTrigger;
    for (var i = 0; i < openModalTriggers.length; i++) {
      openModalTrigger = openModalTriggers[i];
      openModalTrigger.addEventListener('click', function(e) {
        var targetName = e.target.getAttribute('data-action-open-modal');
        var pathIndex = e.target.getAttribute('data-path-index');
        var path = jsonData.paths[pathIndex];
        var selector = document.querySelector(targetName).cloneNode(true);

        const percentRevenueSelector = selector.content.querySelector('[data-percent-revenue]');
        const currenciesSelector = selector.content.querySelector('[data-currencies]');
        const finalBalanceSelector = selector.content.querySelector('[data-final-balance]');
        percentRevenueSelector.innerHTML = path.percentRevenue;
        currenciesSelector.innerHTML = path.currencies.join(', ');
        finalBalanceSelector.innerHTML = path.balance['ltc'];

        var tradeStepsSelector = selector.content.querySelector('[data-trade-steps-table] tbody');
        var tradeSteps = path.path;
        for(var i = 0; i < tradeSteps.length; i++) {
          tradeStepsSelector.innerHTML +=
              '<tr>'
              + '<td class="text-center">' + (i + 1) + '</td>'
              + '<td class="text-right">' + tradeSteps[i].buyAmount + '</td>'
              + '<td class="text-left">' + tradeSteps[i].buy.toUpperCase() + '</td>'
              + '<td class="text-right">' + tradeSteps[i].sellAmount + '</td>'
              + '<td class="text-left">' + tradeSteps[i].sell.toUpperCase() + '</td>'
              + '<td class="text-right">' + tradeSteps[i].price + '</td>'
              + '<td class="text-left">' + tradeSteps[i].sell.toUpperCase() + '</td>'
            + '</tr>';
        }

        document
          .querySelector('body')
          .appendChild(selector.content);
        Modals.reloadCloseTriggers();
      });
    }
  }
}

</script>
</body>
</html>