<!DOCTYPE html>
<html>
<head>
    <title>Graph Trade Web GUI</title>
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">

    <link rel="stylesheet" href="../components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">

    <script src="../components/fetch/fetch.js" type="text/javascript" charset="utf-8" async defer></script>
</head>
<body>

<div class="container">
    <div class="row">
        <h2>Most valuable paths list</h2>
    </div>
    <div class="row">
        <div class="six columns">
            <label for="currency">Currency to sell</label>
            <input class="u-full-width" placeholder="ltc" id="currency" type="text" value="ltc" name="currency">
        </div>
        <div class="six columns">
            <label for="sell-currency">Amount</label>
            <input class="u-full-width" placeholder="1" id="amount" type="text" value="1" name="amount">
        </div>
        <div>
            <button class="button-primary" id="search-paths" type="submit">Search</button>
        </div>
    </div>
    <div class="row">
        <table class="u-full-width">
            <thead>
                <tr>
                    <th>Final balance</th>
                    <th>Revenue (%)</th>
                    <th>Currencies</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="paths-container"></tbody>
        </table>
    </div>
</div>

<template id="path-pattern">
    <tr>
        <td>
            {balances}
        </td>
        <td>{percentRevenue}%</td>
        <td>{currencies}</td>
        <td>
            <button class="button-primary">Start trading</button>
            <button>Show more</button>
        </td>
    </tr>
    <tr></tr>
</template>

<script>

    var searchPathButton = document.getElementById('search-paths');
    searchPathButton.addEventListener("click", function(e) {
        var currency = document.getElementById('currency').value;
        var amount = parseFloat(document.getElementById('amount').value);
        fetchPaths(
            currency,
            amount,
            renderPaths
        );
    });

    var fetchPaths = function(currency, amount, callback) {
        fetch('http://localhost:3000/api/v1/paths/initial/' + currency + '/amount/' + amount)
            .then(function(response) {
                return response.json()
            }).then(function(json) {
                callback(json, currency, amount);
            }).catch(function(ex) {
                console.error(ex)
            });
      };

    var renderPaths = function(response, originCurrency, originAmount) {
        var paths = response.paths,
            pathsContainer = document.getElementById('paths-container'),
            pathDom,
            innerHtml,
            balances,
            currencies,
            percentRevenue,
            currPath;

        for(var i = 0; i < paths.length; i++) {
            pathDom = document.querySelector('#path-pattern').cloneNode(true);
            pathDom.classList.remove('pattern');
            pathDom.removeAttribute('id');
            innerHtml = pathDom.innerHTML;

            currPath = paths[i];
            currencies = currPath.currencies.join(', ');
            percentRevenue = Math.floor((currPath.balance[originCurrency] - originAmount / originAmount) * 10000) / 100;

            balances = '<p>' + currPath.balance[originCurrency] + originCurrency.toUpperCase() + '<p>';
            balances += '<ul hidden>'
            for(var balance in currPath.balance) {
                balances += '<li>' + currPath.balance[balance] + ' ' + balance.toUpperCase() + '</li>';
            }
            balances += '</ul>'

            innerHtml = innerHtml
                .replace('{balances}', balances)
                .replace('{currencies}', currencies)
                .replace('{percentRevenue}', percentRevenue);

            pathDom.innerHTML = innerHtml;
            pathsContainer.appendChild(pathDom.content);
        }
    };

    </script>
</body>
</html>