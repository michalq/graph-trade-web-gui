<!DOCTYPE html>
<html>
<head>
    <title>Graph Trade Web GUI</title>
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">

    <link rel="stylesheet" href="../components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">

    <!-- <script src="../components/fetch/fetch.js" type="text/javascript" charset="utf-8" async defer></script> -->
</head>
<body>

<div hidden class="alert alert-danger" id="error-block" role="alert">
  <strong>Oh snap!</strong> Change a few things up and try submitting again.
</div>

<div class="container">
    <div class="row">
        <h2>Most valuable paths list</h2>
    </div>
    <div class="row">
    <form>
        <div class="form-group">
            <label for="currency">Currency to sell</label>
            <input class="form-control" placeholder="ltc" id="currency" type="text" value="ltc" name="currency">
        </div>
        <div class="form-group">
            <label for="sell-currency">Amount</label>
            <input class="form-control" placeholder="1" id="amount" type="text" value="1" name="amount">
        </div>
        <div>
            <button class="btn btn-primary" id="search-paths" type="button">Search</button>
        </div>
        </form>
    </div>
    <div class="row">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Final balance</th>
                    <th>Revenue (%)</th>
                    <th>Currencies</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="paths-container"></tbody>
        </table>
    </div>
</div>

<template id="path-pattern">
    <tr>
        <td>
            {balances}
        </td>
        <td>{percentRevenue}%</td>
        <td>{currencies}</td>
        <td>
            <div class="btn-group btn-group-md">
                <button class="btn btn-secondary">Trade</button>
                <button class="btn btn-secondary">More</button>
            </div>
        </td>
    </tr>
</template>

<script>
    var searchPathButton = document.getElementById('search-paths');
    searchPathButton.addEventListener("click", function(e) {
        var currency = document.getElementById('currency').value;
        var amount = parseFloat(document.getElementById('amount').value);

        fetchPaths(
            currency,
            amount,
            renderPaths
        );
    });

    var fetchPaths = function(currency, amount, callback) {
        fetch('http://localhost:3000/api/v1/paths/initial/' + currency + '/amount/' + amount)
            .then(function(response) {
                return response.json();
            })
            .then(function(json) {
                if (typeof json.error == 'undefined') {
                    callback(json, currency, amount);
                } else {
                    showError(json.error.message);
                }
            }).catch(function(ex) {
                showError(ex.message);
            });
      };

    var renderPaths = function(response, originCurrency, originAmount) {
        var paths = response.paths,
            pathsContainer = document.getElementById('paths-container'),
            pathDom,
            innerHtml,
            balances,
            currencies,
            percentRevenue,
            currPath,
            highestRevenueId = null,
            highestRevenue = 0,
            rowId;

        for(var i = 0; i < paths.length; i++) {
            pathDom = document.querySelector('#path-pattern').cloneNode(true);
            innerHtml = pathDom.innerHTML;
            rowId = 'paths-row-' + i;

            currPath = paths[i];
            currencies = currPath.currencies.join(', ');
            percentRevenue = Math.floor((currPath.balance[originCurrency] - originAmount / originAmount) * 10000) / 100;
            balances = currPath.balance[originCurrency] + originCurrency.toUpperCase();

            if (percentRevenue > highestRevenue) {
                highestRevenueId = rowId;
                highestRevenue = percentRevenue;
            }

            innerHtml = innerHtml
                .replace('{balances}', balances)
                .replace('{currencies}', currencies)
                .replace('{percentRevenue}', percentRevenue);

            pathDom.innerHTML = innerHtml;
            pathDom.content.querySelector('tr').setAttribute('id', rowId)
            pathsContainer.appendChild(pathDom.content);
        }

        if (highestRevenueId) {
            document.getElementById(highestRevenueId).classList.add('table-success');
        }
    };

    var showError = function(message) {
        var errorBlock = document.getElementById('error-block');
        var pathsContainer = document.getElementById('paths-container');
        errorBlock.removeAttribute('hidden');
        errorBlock.innerHTML = message;
        pathsContainer.innerHTML = '';
    };

    var hideError = function() {
        var errorBlock = document.getElementById('error-block');
        errorBlock.setAttribute('hidden');
        errorBlock.innerHTML = '';
    }

    </script>
</body>
</html>